sudo: required
dist: trusty
language: ruby

before_install:
- gem install asciidoctor -v 1.5.2
- gem install tilt
- sudo pip install git+https://github.com/gitenberg-dev/gitberg
- sudo pip install git+https://github.com/gitenberg-dev/pg-epubmaker
script:
- VERSION=`ruby -e "require 'yaml'; meta = YAML.load_file('metadata.yaml'); puts meta['_version'];"`
- git clone https://github.com/gitenberg-dev/asciidoctor-htmlbook.git
- sudo pip install -r asciidoctor-htmlbook/gitberg-machine/requirements.txt

- /usr/bin/python -c "from gitenberg import travis; travis.build_epub()"
- ebook-convert book.epub book.mobi
- xvfb-run ebook-convert book.epub book.pdf
notifications:
  webhooks:
    urls:
      - https://unglue.it/api/travisci/webhook
    on_success: always
    on_failure: never
    on_start: never
deploy:
  skip_cleanup: true
  provider: releases
  api_key:
    secure: UFu4owJSLhgqXEkIBybNtGXqyENujgQ8uYFzcDthEP2OnhumgtjVFzlmj0gAZF1/kBLgXBXqgmnUJAbvWlFkocRUPUS9/F03ITmOzwgDIFq++3X5EuHSfCxJBXfKp9bEshNO2SVMfbsyIaWmIAUu381XD3Eg+RNq0+Gl+Xbh8mcNJ/GSrVtpuvlY0WrJfM8Bx7SPTfWFItzFc6xiG7KlBO9jUG6y2AucbE2qm7tUlFiG7cQCSpeyGGXcZ2ME0EBHEJaKeZ8+wjvCYI2VmNWye8HOR7iAhb+mbniGOp8kCJFzwuLarpOu2DDBIOLuIMqafOcBaPwcNaAuebiz809BjhGSwq8qHoqulps+jqzMZ7byeTdTirQ9KqEyDFIbD5Qw9NMnAcyaxKL8iA5yheDWm94XGu73SP6dCMJTaaywHk9S9YNfcUJvnIb6sWeSMLdQ7yAScAi6TXHUfF8+ht3/38FJPmDbQMG9hOFMfM8i5Abho1EZC8o6I7FsW6E4U7tvHFqIflPTU/wELLxztWicmxEGyGBO/WKtmPttzII2z+a7Y5MU1mqFwCqHKyweOls0ebOIYkt4P7WJVRLKVzr65I/qL8gph5ruID9g0YOPT1S0wTLSoctG7z3jtb6cUW7NsRdCUsGzNz3X0RDhlDLCs1QZTj5fhK3DIFufVsbPylM=
  file:
    - book.epub
    - book.mobi
    - book.pdf
  on:
    repo: GITenberg/A-Journal-of-the-Plague-Year--13-Written-by-a-Citizen-Who-Continued-All-the-While-in-London_376
    tags: true
addons:
  apt:
    packages:
    - xsltproc
    - xvfb
    - calibre
    - python-pip
    - git
    - python-dev
    - libjpeg-dev
    - libpng-dev
    - libfreetype6
    - libfreetype6-dev
    - zlib1g-dev
    - python-lxml
    - libxml2-dev
    - libxslt1-dev
    - tidy